<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>popup-box</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script type="text/javascript" src="js/popupbox.js"></script>
</head>
<body>
<p>vsmfkvsdfbsdfb
sdf
vsdfvb
sdfvsdfvsfv</p>
<!-- 放在最高层级 -->
<div class="popupbox" onmousedown="upLevel(event)">
	<div class="title" data-pressed="false" onmousedown="mousedown(event)">2333</div>
	<div class="close" onclick="closeBox(event)"></div>
	<!-- 排他性弹框有hide属性 -->
	<!-- <div class="hide" onclick=""></div> -->
</div>
<div class="popupbox" onmousedown="upLevel(event)">
	<div class="title" data-pressed="false" onmousedown="mousedown(event)">firefox</div>
	<div class="close" onclick="closeBox(event)"></div>
</div>
<script type="text/javascript">
var{log, dir, assert, info, table} = console;
window.Mouse = {
	dragStartMousePos: {
		x: null,
		y: null
	},
	dragStartTargetPos: {
		x: null,
		y: null
	},
	dragEle: null
}
var a = new Popupbox();

function boxdragStart(e){
	var currTag = e.currentTarget;
	var inputId = currTag.parentNode.getAttribute('for');
	document.getElementById(inputId).checked = true;
	currTag.setAttribute('data-pressed', 'true');
	Mouse.dragStartMousePos.x = e.pageX;
	Mouse.dragStartMousePos.y = e.pageY;
	Mouse.dragStartTargetPos.x = currTag.getBoundingClientRect().left;
	Mouse.dragStartTargetPos.y = currTag.getBoundingClientRect().top;
	Mouse.dragEle = currTag;
}

function mousedown(e){
	var currTag = e.currentTarget;
	currTag.setAttribute('data-pressed', 'true');
	Mouse.dragStartMousePos.x = e.pageX;
	Mouse.dragStartMousePos.y = e.pageY;
	Mouse.dragStartTargetPos.x = currTag.getBoundingClientRect().left;
	Mouse.dragStartTargetPos.y = currTag.getBoundingClientRect().top;
	Mouse.dragEle = currTag;
}

function upLevel(e){
	// 提升当前弹框到顶层
	e.currentTarget.parentNode.appendChild(e.currentTarget);
}

function closeBox(e){
	var popupboxEle = e.currentTarget.parentNode;
	e.currentTarget.parentNode.style.display = 'none';
	popupboxEle.parentNode.removeChild(popupboxEle);
}

window.onmousemove = function(e){
	if(Mouse.dragEle == null){
		return;
	}
	if(Mouse.dragEle.getAttribute('data-pressed') == 'true'){
		var popupboxEle = Mouse.dragEle.parentNode;
		var boundRect = popupboxEle.getBoundingClientRect();
		var boxWidth = boundRect.width;
		var boxHeight = boundRect.height;
		var newX = Mouse.dragStartTargetPos.x - Mouse.dragStartMousePos.x + e.pageX;
		var newY = Mouse.dragStartTargetPos.y - Mouse.dragStartMousePos.y + e.pageY;
		// 限制弹框位置，避免超出窗口后无法拖动
		if(newX+boxWidth < 20)
			newX = 20 - boxWidth;
		else if(window.innerWidth-newX < 20)
			newX = window.innerWidth - 20;
		if(newY < 0)
			newY = 0;
		else if(window.innerHeight-newY < 20)
			newY = window.innerHeight - 20;
		// 防止拖动窗口导致丢失弹框，采用百分数定位
		newX = newX / window.innerWidth * 100;
		newY = newY / window.innerHeight * 100;
		popupboxEle.style.top = newY + '%';
		popupboxEle.style.left = newX + '%';
	};
}
window.onmouseup = function(e){
	if(Mouse.dragEle == null){
		return;
	}
	Mouse.dragEle.setAttribute('data-pressed', 'false');
}
</script>
</body>
</html>